<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utkarsh Exam Portal</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { --primary: #00b0ff; --bg: #f2f4f8; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; color: #1e293b; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Header */
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-text { font-weight: 800; font-size: 1.2rem; color: #4361ee; }
        .login-btn { font-size: 0.9rem; font-weight: bold; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid white; }
        .box img { width: 50px; height: 50px; margin-bottom: 10px; border-radius: 10px; }

        /* Full Screen Sheet */
        .sheet { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #f8f9fa; z-index: 99999; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .sheet.active { transform: translateX(0); }
        .sheet-header { background: white; padding: 12px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }
        
        /* Lists */
        .list { overflow-y: auto; flex-grow: 1; padding: 15px 20px 80px 20px; }
        .test-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .card-info { flex-grow: 1; }
        .card-title { font-weight: 700; font-size: 0.95rem; }
        .start-btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.85rem; text-decoration: none; }
        
        .attempted-badge { background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body>

<header>
    <span class="logo-text">Exam Portal</span>
    <div id="authBtn" class="login-btn" onclick="handleAuth()">
        <i class="fas fa-user-circle"></i> Login
    </div>
</header>

<div class="grid" id="examGrid">Loading...</div>

<div class="sheet" id="sheet">
    <div class="sheet-header">
        <i class="fas fa-arrow-left" onclick="goBack()" style="font-size:1.2rem; cursor:pointer;"></i>
        <span style="font-weight:bold; font-size:1.1rem; flex-grow:1;" id="sheetTitle">Exam</span>
    </div>
    <div id="topTabsContainer" style="padding:10px 20px; background:white; display:flex; gap:10px;"></div>
    <div id="mainMenuContainer" style="padding:0 20px; background:white; border-bottom:1px solid #eee; display:flex; gap:20px; overflow-x:auto;"></div>
    <div class="list" id="listContainer"></div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDwGzTPmFg-gjoYtNWNJM47p22NfBugYFA",
        authDomain: "mock-test-1eea6.firebaseapp.com",
        databaseURL: "https://mock-test-1eea6-default-rtdb.firebaseio.com",
        projectId: "mock-test-1eea6",
        storageBucket: "mock-test-1eea6.firebaseapp.com",
        messagingSenderId: "111849173136",
        appId: "1:111849173136:web:8b211f58d854119e88a815",
        measurementId: "G-5RLWPTP8YD"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let allData = [];
    let currentUser = null;
    let userResults = {};

    // Auth Logic
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('authBtn').innerHTML = `<img src="${user.photoURL}" style="width:25px; border-radius:50%;"> ${user.displayName.split(' ')[0]}`;
            // Fetch User Results
            db.ref(`users/${user.uid}/results`).on('value', s => {
                userResults = s.val() || {};
                // Refresh list if open
                if(document.getElementById('sheet').classList.contains('active')) renderList(currentListItems);
            });
        } else {
            currentUser = null;
            userResults = {};
            document.getElementById('authBtn').innerHTML = `<i class="fas fa-user-circle"></i> Login`;
        }
    });

    function handleAuth() {
        if(!currentUser) {
            const p = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(p).catch(e => alert(e.message));
        } else {
            if(confirm("Logout?")) auth.signOut();
        }
    }

    // Load Data
    db.ref('exams').on('value', snapshot => {
        const data = snapshot.val();
        const grid = document.getElementById('examGrid');
        grid.innerHTML = "";
        if(!data) return;
        
        allData = Object.values(data);
        const cats = [...new Set(allData.map(i => i.category))];

        cats.forEach(cat => {
            const item = allData.find(d => d.category === cat);
            let icon = item.icon || "https://cdn-icons-png.flaticon.com/512/2995/2995620.png";
            grid.innerHTML += `
                <div class="box" onclick="openSheet('${cat}')">
                    <img src="${icon}">
                    <div class="box-title">${cat}</div>
                </div>`;
        });
    });

    // Navigation Logic
    let currentListItems = [];

    function openSheet(cat) {
        document.getElementById('sheetTitle').innerText = cat;
        document.getElementById('sheet').classList.add('active');
        history.pushState(null, null, location.href);
        
        // Simple logic for demo (filtering by first Tab/Menu)
        const items = allData.filter(d => d.category === cat);
        renderList(items); 
    }

    function renderList(items) {
        currentListItems = items;
        const list = document.getElementById('listContainer');
        list.innerHTML = "";
        
        items.forEach(item => {
            // Extract Quiz ID from Link
            let quizId = null;
            try {
                const url = new URL(item.link, window.location.href);
                quizId = url.searchParams.get('quiz');
            } catch(e) {}

            // Check Status
            let btnText = "Start Now";
            let btnStyle = "";
            let badge = "";
            let clickAction = `window.location.href='${item.link}'`;

            // 1. Check if Attempted
            if(quizId && userResults[quizId]) {
                const res = userResults[quizId];
                btnText = "Re-Attempt";
                badge = `<div class="attempted-badge">âœ” Score: ${res.score}/${res.total}</div>`;
                btnStyle = "background:#fff; color:#2e7d32; border:1px solid #2e7d32;";
            }

            // 2. Check Time (Live Test Logic)
            if (item.startTime && item.endTime) {
                const now = new Date().getTime();
                const start = new Date(item.startTime).getTime();
                const end = new Date(item.endTime).getTime();

                if (now < start) {
                    btnText = "Coming Soon";
                    btnStyle = "background:#fbc531;";
                    clickAction = "alert('Wait for start time!')";
                    badge = `<div style="color:#e67e22; font-size:0.75rem;">ðŸ•’ Starts: ${new Date(item.startTime).toLocaleTimeString()}</div>`;
                } else if (now > end) {
                    btnText = "Expired";
                    btnStyle = "background:#95a5a6;";
                    clickAction = "alert('Test Ended!')";
                } else {
                    btnText = "ðŸ”´ LIVE";
                    btnStyle = "background:#e74c3c; animation: pulse 1s infinite;";
                }
            }

            list.innerHTML += `
                <div class="test-card">
                    <div class="card-info">
                        <div class="card-title">${item.chapter}</div>
                        <div style="font-size:0.8rem; color:#666;">${item.subject}</div>
                        ${badge}
                    </div>
                    <button class="start-btn" style="${btnStyle}" onclick="${clickAction}">${btnText}</button>
                </div>
            `;
        });
    }

    function goBack() {
        document.getElementById('sheet').classList.remove('active');
    }
    window.onpopstate = goBack;
</script>

<style>
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
</style>

</body>
</html>
